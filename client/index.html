<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        canvas {
            border: 1px solid #d3d3d3;
            background-color: #f1f1f1;
        }
    </style>


    <script src="https://cdn.socket.io/4.1.1/socket.io.min.js"
        integrity="sha384-cdrFIqe3RasCMNE0jeFG9xJHog/tgOVC1E9Lzve8LQN1g5WUHo0Kvk1mawWjxX7a"
        crossorigin="anonymous"></script>

</head>

<body onload="startGame()">
    <script>

        var myGamePiece;
        var players = []
        var width = 480
        var height = 270
        var size = 30
        var speed = 1
        var gameUpdate = 10
        var socketUrl = 'http://127.0.0.1:3000'

        const socket = io(socketUrl)

        socket.on('playerConnected', data => {
            data.forEach(p => {
                if (p.id !== socket.id && !players.some(p2 => p2.name === p.id)) {
                    players.push(new component(30, 30, "assets/smiley.gif", p.x, p.y, "image", p.id))
                }
            })
        })

        socket.on('playermove', data => {
            const player = players.find(p => p.name === data.id)
            if (player) {
                player.x = data.x
                player.y = data.y
            }
        })

        socket.on('logout', id => {
            const index = players.findIndex(p => p.name === id)
            players.splice(index, 1)
            // delete players[index]
        })

        function startGame() {
            const rand = Math.floor(Math.random() * 100) + 10
            myGamePiece = new component(30, 30, "assets/smiley.gif", rand, 120, "image", 'user');
            myGameArea.start();
            socket.emit('login', { x: rand, y: 120 })
        }

        var myGameArea = {
            canvas: document.createElement("canvas"),
            start: function () {
                this.canvas.width = width;
                this.canvas.height = height;
                this.context = this.canvas.getContext("2d");
                document.body.insertBefore(this.canvas, document.body.childNodes[0]);
                // this.frameNo = 0;
                this.interval = setInterval(updateGameArea, gameUpdate);
                window.addEventListener('keydown', function (e) {
                    myGameArea.keys = (myGameArea.keys || []);
                    myGameArea.keys[e.keyCode] = (e.type == "keydown");
                })
                window.addEventListener('keyup', function (e) {
                    myGameArea.keys[e.keyCode] = (e.type == "keydown");
                })
            },
            clear: function () {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            },
            stop: function () {
                clearInterval(this.interval);
            }
        }

        function component(width, height, color, x, y, type, name) {
            this.name = name
            this.type = type;
            if (type == "image") {
                this.image = new Image();
                this.image.src = color;
            }
            this.width = width;
            this.height = height;
            this.speedX = 0;
            this.speedY = 0;
            this.x = x;
            this.y = y;
            this.update = function () {
                ctx = myGameArea.context;
                if (type == "image") {
                    ctx.drawImage(this.image,
                        this.x,
                        this.y,
                        this.width, this.height);
                } else {
                    ctx.fillStyle = color;
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                }
            }
            this.newPos = function () {
                this.x += this.speedX;
                this.y += this.speedY;
            }
        }

        function updateGameArea() {
            myGameArea.clear();

            myGamePiece.image.src = "assets/smiley.gif";

            myGamePiece.speedX = 0;
            myGamePiece.speedY = 0;

            if (myGamePiece.x > 0 && myGameArea.keys && myGameArea.keys[37]) {
                myGamePiece.image.src = "assets/angry.gif";
                myGamePiece.speedX = -speed
            }
            if (myGamePiece.x < width - size && myGameArea.keys && myGameArea.keys[39]) { myGamePiece.speedX = speed }
            if (myGamePiece.y > 0 && myGameArea.keys && myGameArea.keys[38]) { myGamePiece.speedY = -speed }
            if (myGamePiece.y < height - size && myGameArea.keys && myGameArea.keys[40]) { myGamePiece.speedY = speed }

            if (myGamePiece.speedX || myGamePiece.speedY) socket.emit('move', { x: myGamePiece.x, y: myGamePiece.y })

            myGamePiece.newPos();
            myGamePiece.update();

            players.forEach(p => {
                // if (p.name === data.id) {
                p.newPos()
                p.update()
                // }
            })
        }

        function move(dir) {
            myGamePiece.image.src = "assets/angry.gif";

            if (dir == "up") { myGamePiece.speedY = -1; }
            if (dir == "down") { myGamePiece.speedY = 1; }
            if (dir == "left") { myGamePiece.speedX = -1; }
            if (dir == "right") { myGamePiece.speedX = 1; }
        }

        function clearmove() {
            myGamePiece.image.src = "assets/smiley.gif";
            myGamePiece.speedX = 0;
            myGamePiece.speedY = 0;
        }
    </script>
    <!-- <div style="text-align:center;width:480px;">
        <button onmousedown="move('up')" onmouseup="clearmove()" ontouchstart="move('up')">UP</button><br><br>
        <button onmousedown="move('left')" onmouseup="clearmove()" ontouchstart="move('left')">LEFT</button>
        <button onmousedown="move('right')" onmouseup="clearmove()" ontouchstart="move('right')">RIGHT</button><br><br>
        <button onmousedown="move('down')" onmouseup="clearmove()" ontouchstart="move('down')">DOWN</button>
    </div> -->

</body>

</html>