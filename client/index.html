<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        #div {
            text-align: center;
        }

        #canvas {
            margin-top: -8px;
            border: 1px solid #d3d3d3;
            background-color: #f1f1f1;
        }
    </style>

    <script src="https://cdn.socket.io/4.1.1/socket.io.min.js"></script>

</head>

<body>
    <div id="div">
        <canvas id="canvas" width="800" height="480"></canvas>
        <!-- <textarea id="textbox"></textarea> -->
    </div>
    <div id="div2">
        <textarea id="chat"></textarea>
        <input id="input">
    </div>
    <script>

        const socketUrl = 'localhost:3000'
        const socket = io(socketUrl)
        let user
        const players = []
        const messageList = []
        const SCALE = 2
        const WIDTH = 16.1
        const HEIGHT = 18.1
        const SCALED_WIDTH = SCALE * WIDTH
        const SCALED_HEIGHT = SCALE * HEIGHT
        const CYCLE_LOOP = [0, 1, 0, 2]
        const FACING_DOWN = 0
        const FACING_UP = 1
        const FACING_LEFT = 2
        const FACING_RIGHT = 3
        const FRAME_LIMIT = 12
        const MOVEMENT_SPEED = 1

        let frameCount = 0
        let canvas = document.getElementById('canvas')
        let ctx = canvas.getContext('2d')
        let keyPresses = {}
        let message = ''
        let userChatTimeout

        let input = document.getElementById('input')
        input.id = 'input'
        input.autofocus = true
        input.hidden = true
        input.max = 100
        input.style = `
            position: absolute;
            left: 39.5%;
            top: 450px;
            width: 300px;
        `

        let chat = document.getElementById('chat')
        chat.id = 'chat'
        chat.disabled = true
        chat.focus = true
        chat.hidden = true
        chat.style = `
            position: absolute;
            left: 39.5%;
            top: 335px;
            width: 300px;
            height: 100px;
            resize:none
        `

        // let textBox = document.createElement('textarea')
        // textBox.id = socket.id
        // textBox.disabled = true
        // textBox.focus = true
        // textBox.hidden = true
        // document.body.insertBefore(textBox, document.body.childNodes[0])

        socket.on(`playerconnected`, data => {
            data.forEach(p => {
                if (p.id !== socket.id && !players.some(p2 => p2.id === p.id)) {
                    console.log(p)
                    players.push(new component(SCALED_WIDTH, SCALED_HEIGHT, p.x, p.y, p.id, p.name, p.chatId))
                }
            })
        })

        socket.on('playermove', data => {
            const index = players.findIndex(p => p.id === data.id)
            if (index !== -1) {
                players[index].x = data.x
                players[index].y = data.y
                players[index].currentDirection = data.currentDirection
                players[index].currentLoopIndex = data.currentLoopIndex
            }
        })

        socket.on('chat-world', data => {
            if (messageList.length > 99) {
                messageList.splice(0, 1)
            }
            messageList.push(` ${data.name}: ${data.message}\n`)
            chat.value = messageList.join('')
            chat.scrollTop = chat.scrollHeight
            const index = players.findIndex(p => p.name === data.name)
            if (players[index]) {
                players[index].message = data.message
                clearTimeout(players[index].messageTimeout)
                players[index].messageTimeout = setTimeout(() => {
                    players[index].message = ''
                    document.getElementById(players[index].chatId).hidden = true
                }, 5000)
            }
        })

        socket.on('logout', id => {
            const index = players.findIndex(p => p.id === id)
            players.splice(index, 1)
        })

        window.onload = () => {

            const name = prompt('Player name')
            const id = randomId(10)
            user = new component(30, 30, 0, 0, socket.id, name, id)

            window.addEventListener('keydown', (event) => {
                canvas.keys = (canvas.keys || [])
                canvas.keys[event.keyCode] = (event.type == "keydown")

                // enter
                if (canvas.keys && canvas.keys[13]) {
                    if (input.hidden && !input.value) {
                        input.hidden = false
                        chat.hidden = false
                        input.select()
                    } else if (!input.hidden && input.value) {
                        input.hidden = false
                        chat.hidden = false
                        user.textBox.hidden = false
                        user.message = input.value
                        socket.emit('chat', { type: 'world', name: user.name, message: input.value })
                        input.value = ''

                        // hide message after pressed enter in 5 sec
                        clearTimeout(user.messageTimeout)
                        user.messageTimeout = setTimeout(() => {
                            user.message = ''
                            document.getElementById(user.chatId).hidden = true
                        }, 5000)

                    } else {
                        input.hidden = true
                        chat.hidden = true
                    }
                }

            })

            window.addEventListener('keyup', (event) => {
                canvas.keys[event.keyCode] = (event.type == "keydown")
            })

            socket.emit('login', { x: 0, y: 0, name, chatId: id })

            setInterval(gameLoop, 1000 / 60)

        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height)

            let hasMoved = false

            if (canvas.keys && canvas.keys[38]) {
                moveCharacter(0, -MOVEMENT_SPEED, FACING_UP)
                hasMoved = true
            } else if (canvas.keys && canvas.keys[40]) {
                moveCharacter(0, MOVEMENT_SPEED, FACING_DOWN)
                hasMoved = true
            }

            if (canvas.keys && canvas.keys[37]) {
                moveCharacter(-MOVEMENT_SPEED, 0, FACING_LEFT)
                hasMoved = true
            } else if (canvas.keys && canvas.keys[39]) {
                moveCharacter(MOVEMENT_SPEED, 0, FACING_RIGHT)
                hasMoved = true
            }

            if (hasMoved) {
                frameCount++
                if (frameCount >= FRAME_LIMIT) {
                    frameCount = 0
                    user.currentLoopIndex++
                    if (user.currentLoopIndex >= CYCLE_LOOP.length) {
                        user.currentLoopIndex = 0
                    }
                }
            }

            if (!hasMoved) {
                user.currentLoopIndex = 0
            }

            user.update()
            user.drawTextBox()

            players.forEach(p => {
                p.update()
                p.drawTextBox()
            })

            if (hasMoved) {
                socket.emit('move', {
                    x: user.x,
                    y: user.y,
                    currentDirection: user.currentDirection,
                    currentLoopIndex: user.currentLoopIndex
                })
            }
        }

        function randomId(length) {
            var result = [];
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < length; i++) {
                result.push(characters.charAt(Math.floor(Math.random() *
                    charactersLength)));
            }
            return result.join('');
        }

        function drawName(name, x, y) {
            ctx.fillStyle = "black"
            ctx.font = "12px Tahoma"
            ctx.textAlign = 'center'
            ctx.fillText(name, x + 15, y + 50)
        }

        function drawFrame(image, frameX, frameY, canvasX, canvasY) {
            ctx.drawImage(image,
                frameX * WIDTH,
                frameY * HEIGHT,
                WIDTH,
                HEIGHT,
                canvasX,
                canvasY,
                SCALED_WIDTH,
                SCALED_HEIGHT)
        }

        function moveCharacter(deltaX, deltaY, direction) {
            if (user.x + deltaX > 0 && user.x + SCALED_WIDTH + deltaX < canvas.width) {
                user.x += deltaX
            }
            if (user.y + deltaY > 0 && user.y + SCALED_HEIGHT + 20 + deltaY < canvas.height) {
                user.y += deltaY
            }
            user.currentDirection = direction
        }

        function component(width, height, x, y, id, name, chatId) {

            this.id = id
            this.chatId = chatId
            this.name = name
            this.image = new Image()
            this.image.src = 'https://opengameart.org/sites/default/files/Green-Cap-Character-16x18.png'
            this.width = width
            this.height = height
            this.x = x
            this.y = y
            this.currentDirection = 0
            this.currentLoopIndex = 0
            this.loop = [0, 1, 0, 2]
            this.message = ''
            this.messageTimeout = 0

            this.textBox = document.createElement('textarea')
            this.textBox.id = chatId
            this.textBox.disabled = true
            this.textBox.focus = true
            this.textBox.hidden = true
            document.body.insertBefore(this.textBox, document.body.childNodes[0])

            this.update = () => {

                drawFrame(
                    this.image,
                    this.loop[this.currentLoopIndex],
                    this.currentDirection,
                    this.x,
                    this.y
                )

                drawName(this.name,
                    this.x,
                    this.y
                )

                // this.currentLoopIndex = 0

            }

            this.drawTextBox = () => {

                if (this.message && !this.textBox.hidden) {

                    const messageBox = document.getElementById(this.chatId)
                    messageBox.value = this.message
                    // messageBox.cols = 1
                    messageBox.disabled = true
                    messageBox.hidden = false

                    if (this.x < 85) {
                        posX = (window.innerWidth / 2) - 400
                    } else if (this.x > canvas.width - 119) {
                        posX = (window.innerWidth / 2) + 195
                    } else {
                        posX = (window.innerWidth / 2) - 400 + this.x - 85
                    }

                    if (this.y < 50) {
                        posY = this.y + 60
                    } else {
                        posY = this.y - 40
                    }

                    messageBox.style = `
                        color: white;
                        opacity: 0.6;
                        background-color: black;
                        position: absolute;
                        left: ${posX}px;
                        top: ${posY}px;
                        width: 200px;
                        min-height: 1.2;
                        max-height: 100%;
                        resize: none;
                        font-size: 14px;
                    `

                }

            }

        }

    </script>

</body>

</html>