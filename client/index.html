<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        #canvas {
            margin: -8px -8px;
            border: 1px solid #d3d3d3;
            background-color: #f1f1f1;
        }

        #chat {
            position: absolute;
            left: 10px;
            top: 335px;
            width: 600px;
            height: 100px;
        }

        #input {
            position: absolute;
            left: 10px;
            top: 450px;
            width: 600px;
        }
    </style>

    <script src="https://cdn.socket.io/4.1.1/socket.io.min.js"
        integrity="sha384-cdrFIqe3RasCMNE0jeFG9xJHog/tgOVC1E9Lzve8LQN1g5WUHo0Kvk1mawWjxX7a"
        crossorigin="anonymous"></script>

</head>

<body onload="startGame()">
    <script>

        var name = prompt('Player name.')
        var myGamePiece
        var players = []
        var chat = []
        var width = 800
        var height = 480
        var size = 30
        var speed = 3
        var fps = 60
        var socketUrl = '127.0.0.1:3000'

        const socket = io(socketUrl)

        socket.on(`playerconnected`, data => {
            data.forEach(p => {
                if (p.id !== socket.id && !players.some(p2 => p2.id === p.id)) {
                    players.push(new component(30, 30, "assets/smiley.gif", p.x, p.y, "image", p.id, p.name))
                }
            })
        })

        socket.on('playermove', data => {
            const player = players.find(p => p.id === data.id)
            if (player) {
                player.x = data.x
                player.y = data.y
            }
        })

        socket.on('chat-world', data => {
            if (chat.length > 99) {
                chat.splice(0, 1)
            }
            chat.push(` ${data.name}: ${data.message}\n`)
            myGameArea.chat.value = chat.join("")
            myGameArea.chat.scrollTop = myGameArea.chat.scrollHeight
        })

        socket.on('logout', id => {
            const index = players.findIndex(p => p.id === id)
            players.splice(index, 1)
            // delete players[index]
        })

        function startGame() {
            const rand = Math.floor(Math.random() * 100) + 10
            myGamePiece = new component(30, 30, "assets/smiley.gif", rand, 120, "image", 'user', name)
            myGameArea.start()
            socket.emit('login', { x: rand, y: 120, name })
        }

        var myGameArea = {
            canvas: document.createElement("canvas"),
            input: document.createElement('input'),
            chat: document.createElement('textarea'),

            start: function () {
                this.canvas.id = 'canvas'
                this.canvas.width = width
                this.canvas.height = height
                this.context = this.canvas.getContext("2d")

                this.input.id = 'input'
                this.input.autofocus = true
                this.input.hidden = true

                this.chat.id = 'chat'
                this.chat.disabled = true
                this.chat.focus = true
                this.chat.style = 'resize:none'
                // this.chat.cols = 73
                // this.chat.rows = 7

                document.body.insertBefore(this.canvas, document.body.childNodes[0])
                document.body.insertBefore(this.chat, document.body.childNodes[1])
                document.body.insertBefore(this.input, document.body.childNodes[2])

                this.interval = setInterval(updateGameArea, 1000 / fps)

                window.addEventListener('keydown', function (e) {
                    myGameArea.keys = (myGameArea.keys || [])
                    myGameArea.keys[e.keyCode] = (e.type == "keydown")

                    // enter
                    if (myGameArea.keys && myGameArea.keys[13]) {
                        if (myGameArea.input.hidden && !myGameArea.input.value) {
                            myGameArea.input.hidden = false
                            this.input.select()
                        } else if (!myGameArea.input.hidden && myGameArea.input.value) {
                            myGameArea.input.hidden = false
                            socket.emit('chat', { type: 'world', name: myGamePiece.name, message: myGameArea.input.value })
                            myGameArea.input.value = ''
                        } else {
                            myGameArea.input.hidden = true
                        }
                    }
                })
                window.addEventListener('keyup', function (e) {
                    myGameArea.keys[e.keyCode] = (e.type == "keydown")
                })
            },
            clear: function () {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height)
            },
            stop: function () {
                clearInterval(this.interval)
            }

        }

        function component(width, height, color, x, y, type, id, name) {
            this.id = id
            this.name = name
            this.type = type
            if (type == "image") {
                this.image = new Image()
                this.image.src = color
            }
            this.width = width
            this.height = height
            this.speedX = 0
            this.speedY = 0
            this.x = x
            this.y = y
            this.update = function () {
                ctx = myGameArea.context
                if (type == "image") {
                    ctx.drawImage(this.image,
                        this.x,
                        this.y,
                        this.width, this.height)
                } else {
                    ctx.fillStyle = color
                    ctx.fillRect(this.x, this.y, this.width, this.height)
                }
                drawText(name, this.x, this.y)
            }
            this.newPos = function () {
                this.x += this.speedX
                this.y += this.speedY
            }
        }

        function updateGameArea() {
            myGameArea.clear()

            myGamePiece.image.src = "assets/smiley.gif"

            myGamePiece.speedX = 0
            myGamePiece.speedY = 0

            // const block = players.some(p => myGamePiece.x > p.x + 15 && myGamePiece.y < p.y + 15)

            // if (!block) {
            if (myGamePiece.x > 0 && myGameArea.keys && myGameArea.keys[37]) {
                myGamePiece.image.src = "assets/angry.gif"
                myGamePiece.speedX = -speed
            }
            if (myGamePiece.x < width - size && myGameArea.keys && myGameArea.keys[39]) { myGamePiece.speedX = speed }
            if (myGamePiece.y > 20 && myGameArea.keys && myGameArea.keys[38]) { myGamePiece.speedY = -speed }
            if (myGamePiece.y < height - size && myGameArea.keys && myGameArea.keys[40]) { myGamePiece.speedY = speed }

            if (myGamePiece.speedX || myGamePiece.speedY) socket.emit('move', { x: myGamePiece.x, y: myGamePiece.y })
            // }

            myGamePiece.newPos()
            myGamePiece.update()

            players.forEach(p => {
                p.newPos()
                p.update()
            })

        }

        function drawText(txt, posX, posY) {
            myGameArea.context.fillStyle = "black"
            myGameArea.context.font = "20px Comic Sans MS"
            myGameArea.context.textAlign = 'center'
            myGameArea.context.fillText(txt, posX, posY);
        }

        function clearmove() {
            // myGamePiece.image.src = "assets/smiley.gif"
            myGamePiece.speedX = 0
            myGamePiece.speedY = 0
        }
    </script>

</body>

</html>